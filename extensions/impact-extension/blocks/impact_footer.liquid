{% comment %}
  Afforestation Footer Badge
  Shows total impact and links to virtual forest
{% endcomment %}

<div class="afforestation-footer-badge" id="afforestation-footer-{{ block.id }}" style="display: none;">
  <div class="footer-badge-content" id="footer-content-{{ block.id }}">
    <div class="footer-badge-icon" id="footer-icon-wrap-{{ block.id }}">
      <span id="footer-icon-{{ block.id }}">ðŸŒ³</span>
    </div>
    <div class="footer-badge-stats" id="footer-stats-{{ block.id }}">
      <div class="footer-stat">
        <span class="footer-stat-value" id="footer-trees-{{ block.id }}">0</span>
        <span class="footer-stat-label" id="footer-label-{{ block.id }}">trees planted</span>
      </div>
    </div>
    <div class="footer-badge-brand" id="footer-brand-{{ block.id }}">
      <span class="footer-brand">Afforestation</span>
    </div>
  </div>
</div>

<script>
  (function() {
    const blockId = '{{ block.id }}';
    const badge = document.getElementById('afforestation-footer-' + blockId);
    const content = document.getElementById('footer-content-' + blockId);
    const iconWrap = document.getElementById('footer-icon-wrap-' + blockId);
    const iconEl = document.getElementById('footer-icon-' + blockId);
    const treesEl = document.getElementById('footer-trees-' + blockId);
    const labelEl = document.getElementById('footer-label-' + blockId);
    const statsEl = document.getElementById('footer-stats-' + blockId);
    const brandEl = document.getElementById('footer-brand-' + blockId);
    
    async function loadData() {
      try {
        const response = await fetch('/apps/afforestation/impact');
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        const s = data.settings || {};
        
        // Check if footer is enabled
        if (s.footerEnabled === false) {
          badge.style.display = 'none';
          return;
        }
        
        // Show badge
        badge.style.display = 'inline-flex';
        
        // Apply styling
        badge.style.setProperty('--footer-primary', s.primaryColor || '#2d5a27');
        badge.style.setProperty('--footer-bg', s.backgroundColor || '#f0fdf4');
        badge.style.setProperty('--footer-border', s.borderColor || 'rgba(45, 90, 39, 0.2)');
        
        // Update icon
        iconEl.textContent = s.treeEmoji || 'ðŸŒ³';
        
        // Apply style variations
        if (s.footerStyle === 'minimal') {
          badge.style.padding = '6px 12px';
          labelEl.style.display = 'none';
          brandEl.style.display = 'none';
        } else if (s.footerStyle === 'detailed') {
          iconEl.style.fontSize = '24px';
          treesEl.style.fontSize = '18px';
        } else {
          // standard
          iconEl.style.fontSize = '20px';
        }
        
        // Apply layout
        if (s.footerLayout === 'stacked') {
          content.style.flexDirection = 'column';
          content.style.gap = '4px';
          statsEl.style.flexDirection = 'column';
          statsEl.style.alignItems = 'center';
        }
        
        // Animation
        if (s.showFooterAnimation === false) {
          iconWrap.style.animation = 'none';
        }
        
        // Branding
        if (s.showFooterBranding === false || s.footerStyle !== 'detailed') {
          brandEl.style.display = 'none';
        }
        
        // Update label
        labelEl.textContent = s.footerMessage || 'trees planted';
        
        // Animate count
        animateCount(treesEl, data.treesPlanted || 0);
        
      } catch (error) {
        console.warn('Afforestation: Could not load data', error);
        // Show default badge on error
        badge.style.display = 'inline-flex';
      }
    }
    
    function animateCount(element, target) {
      const duration = 1500;
      const start = 0;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(start + (target - start) * easeOut);
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    // Load when visible
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadData();
        observer.disconnect();
      }
    }, { threshold: 0.1 });
    
    observer.observe(badge);
  })();
</script>

{% schema %}
{
  "name": "Impact Footer Badge",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "A compact badge showing your total trees planted. Perfect for the footer."
    }
  ]
}
{% endschema %}

<style>
  .afforestation-footer-badge {
    --footer-primary: #2d5a27;
    --footer-bg: #f0fdf4;
    --footer-border: rgba(45, 90, 39, 0.2);
    
    display: inline-flex;
    background: var(--footer-bg);
    border: 1px solid var(--footer-border);
    border-radius: 8px;
    padding: 8px 16px;
    transition: all 0.3s ease;
  }
  
  .afforestation-footer-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 90, 39, 0.15);
  }
  
  .afforestation-footer-badge .footer-badge-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .afforestation-footer-badge .footer-badge-icon {
    font-size: 24px;
    animation: gentle-bounce 2s ease-in-out infinite;
  }
  
  @keyframes gentle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  
  .afforestation-footer-badge .footer-badge-stats {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .afforestation-footer-badge .footer-stat {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }
  
  .afforestation-footer-badge .footer-stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--footer-primary);
  }
  
  .afforestation-footer-badge .footer-stat-label {
    font-size: 12px;
    color: var(--footer-primary);
    opacity: 0.8;
  }
  
  .afforestation-footer-badge .footer-brand {
    font-size: 11px;
    font-weight: 600;
    color: var(--footer-primary);
    opacity: 0.7;
    letter-spacing: 0.5px;
  }
</style>
