{% comment %}
  Afforestation Footer Badge
  Shows total impact and links to virtual forest
  All visual settings are configurable in theme editor
{% endcomment %}

<!-- Flaticon UIcons CSS -->
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>

<div class="afforestation-footer-badge {{ block.settings.layout }}" id="afforestation-footer-{{ block.id }}" style="
  --footer-primary: {{ block.settings.primary_color }};
  --footer-bg: {{ block.settings.background_color }};
  --footer-border: {{ block.settings.primary_color }}33;
">
  <div class="footer-badge-content">
    <div class="footer-badge-icon {% if block.settings.animate %}animate-bounce{% endif %}">
      <span><i class="fi fi-rr-{{ block.settings.icon }}"></i></span>
    </div>
    <div class="footer-badge-stats">
      <div class="footer-stat">
        <span class="footer-stat-value" id="footer-trees-{{ block.id }}">0</span>
        {% unless block.settings.style == 'minimal' %}
        <span class="footer-stat-label">{{ block.settings.label }}</span>
        {% endunless %}
      </div>
    </div>
    {% if block.settings.show_branding and block.settings.style == 'detailed' %}
    <div class="footer-badge-brand">
      <span class="footer-brand">Afforestation</span>
    </div>
    {% endif %}
  </div>
</div>

<script>
  (function() {
    const treesEl = document.getElementById('footer-trees-{{ block.id }}');
    
    function animateCount(element, target) {
      const duration = 1500;
      const start = 0;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(start + (target - start) * easeOut);
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    async function loadData() {
      try {
        const response = await fetch('/apps/afforestation/impact');
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();
        animateCount(treesEl, data.treesPlanted || 0);
      } catch (error) {
        treesEl.textContent = '0';
      }
    }
    
    // Load when visible
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadData();
        observer.disconnect();
      }
    }, { threshold: 0.1 });
    
    observer.observe(document.getElementById('afforestation-footer-{{ block.id }}'));
  })();
</script>

{% schema %}
{
  "name": "Impact Footer Badge",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Display"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label text",
      "default": "trees planted",
      "info": "Write in any language!"
    },
    {
      "type": "select",
      "id": "icon",
      "label": "Icon",
      "options": [
        { "value": "tree", "label": "Tree" },
        { "value": "leaf", "label": "Leaf" },
        { "value": "flower", "label": "Flower" },
        { "value": "seedling", "label": "Seedling" },
        { "value": "earth-americas", "label": "Planet" },
        { "value": "cloud", "label": "Cloud" }
      ],
      "default": "tree"
    },
    {
      "type": "select",
      "id": "style",
      "label": "Badge style",
      "options": [
        { "value": "minimal", "label": "Minimal - icon and count only" },
        { "value": "standard", "label": "Standard - with label" },
        { "value": "detailed", "label": "Detailed - with branding" }
      ],
      "default": "standard"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        { "value": "horizontal", "label": "Horizontal" },
        { "value": "stacked", "label": "Stacked" }
      ],
      "default": "horizontal"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "animate",
      "label": "Animate icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_branding",
      "label": "Show Afforestation branding",
      "default": true,
      "info": "Only visible in Detailed style"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#2d5a27"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f0fdf4"
    }
  ]
}
{% endschema %}

<style>
  .afforestation-footer-badge {
    --footer-primary: #2d5a27;
    --footer-bg: #f0fdf4;
    --footer-border: rgba(45, 90, 39, 0.2);
    
    display: inline-flex;
    background: var(--footer-bg);
    border: 1px solid var(--footer-border);
    border-radius: 8px;
    padding: 8px 16px;
    transition: all 0.3s ease;
  }
  
  .afforestation-footer-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 90, 39, 0.15);
  }
  
  .afforestation-footer-badge .footer-badge-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .afforestation-footer-badge.stacked .footer-badge-content {
    flex-direction: column;
    gap: 4px;
  }
  
  .afforestation-footer-badge .footer-badge-icon {
    font-size: 24px;
  }
  
  .afforestation-footer-badge .footer-badge-icon.animate-bounce {
    animation: gentle-bounce 2s ease-in-out infinite;
  }
  
  @keyframes gentle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  
  .afforestation-footer-badge .footer-badge-stats {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .afforestation-footer-badge.stacked .footer-badge-stats {
    align-items: center;
  }
  
  .afforestation-footer-badge .footer-stat {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }
  
  .afforestation-footer-badge .footer-stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--footer-primary);
  }
  
  .afforestation-footer-badge .footer-stat-label {
    font-size: 12px;
    color: var(--footer-primary);
    opacity: 0.8;
  }
  
  .afforestation-footer-badge .footer-brand {
    font-size: 11px;
    font-weight: 600;
    color: var(--footer-primary);
    opacity: 0.7;
    letter-spacing: 0.5px;
  }
</style>
